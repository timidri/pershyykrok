---
import BaseLayout from '../../layouts/BaseLayout.astro';
import PageContent from '../../components/PageContent.astro';
import FaqContent from '../../components/FaqContent.astro';
import SelfTestContent from '../../components/SelfTestContent.astro';
import { allPageSlugsQuery } from '../../queries';
import {
  fetchFaqBySlugData,
  fetchPageBySlugData,
  fetchSelfTestBySlugData,
  fetchSiteSettings,
} from '../../lib/content';
import { client } from '../../lib/sanity';
import { assertLocaleOrRedirect, isLocale } from '../../lib/locale';

type SlugDoc = { locale: string; slug: string };

export async function getStaticPaths() {
  const docs = await client.fetch<SlugDoc[]>(allPageSlugsQuery);
  if (!docs || docs.length === 0) return [];
  return docs
    .filter((d) => d.locale && d.slug && isLocale(d.locale))
    .map((d) => ({
      params: { locale: d.locale, slug: d.slug },
    }));
}

const { locale, slug } = Astro.params as { locale: string; slug: string | undefined };

const localeValue = assertLocaleOrRedirect(locale, Astro.redirect);

const slugStr = slug ?? '';
if (!slugStr) return Astro.redirect(`/${localeValue}`);

const data = await fetchPageBySlugData({ locale: localeValue, slug: slugStr });
const faq = data ? null : await fetchFaqBySlugData({ locale: localeValue, slug: slugStr });
const selfTest = data || faq ? null : await fetchSelfTestBySlugData({ locale: localeValue, slug: slugStr });
const siteSettings = selfTest ? await fetchSiteSettings({ preview: false }) : null;

if (!data && !faq && !selfTest) return Astro.redirect('/404');
---

<BaseLayout
  title={(data?.title ?? faq?.title ?? selfTest?.title) ?? 'Page'}
  locale={localeValue}
  currentPath={`/${localeValue}/${slugStr}`}
>
  {data && <PageContent data={data} />}
  {faq && <FaqContent title={faq.title} intro={faq.intro} items={faq.items} />}
  {selfTest && (
    <SelfTestContent
      intro={selfTest.intro}
      questions={selfTest.questions}
      resultCopy={selfTest.resultCopy}
      contact={siteSettings?.contact ?? null}
      locale={localeValue}
    />
  )}
</BaseLayout>
