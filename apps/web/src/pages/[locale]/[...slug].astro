---
import BaseLayout from '../../layouts/BaseLayout.astro';
import PageContent from '../../components/PageContent.astro';
import { allPageSlugsQuery } from '../../queries';
import { fetchPageBySlugData } from '../../lib/content';
import { client } from '../../lib/sanity';
import { assertLocaleOrRedirect, isLocale } from '../../lib/locale';

type SlugDoc = { locale: string; slug: string };

export async function getStaticPaths() {
  const docs = await client.fetch<SlugDoc[]>(allPageSlugsQuery);
  if (!docs || docs.length === 0) return [];
  return docs
    .filter((d) => d.locale && d.slug && isLocale(d.locale))
    .map((d) => ({
      params: { locale: d.locale, slug: d.slug },
    }));
}

const { locale, slug } = Astro.params as { locale: string; slug: string | undefined };

const localeValue = assertLocaleOrRedirect(locale, Astro.redirect);

const slugStr = slug ?? '';
if (!slugStr) return Astro.redirect(`/${localeValue}`);

const data = await fetchPageBySlugData({ locale: localeValue, slug: slugStr });

if (!data) return Astro.redirect('/404');
---

<BaseLayout
  title={data.title ?? 'Page'}
  locale={localeValue}
  currentPath={`/${localeValue}/${slugStr}`}
>
  <PageContent data={data} />
</BaseLayout>
