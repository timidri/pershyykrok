---
import { urlForImage } from '../lib/sanity';
import type { SiteSettingsQueryResult } from '../sanity-types';

interface Props {
  siteSettings: SiteSettingsQueryResult;
  locale: 'ru' | 'ua';
  currentPath: string;
}

const { siteSettings, locale, currentPath } = Astro.props;

const menu = locale === 'ua' ? siteSettings?.mainMenuUa : siteSettings?.mainMenuRu;
const otherLocale: 'ru' | 'ua' = locale === 'ua' ? 'ru' : 'ua';
const otherPath = currentPath.replace(`/${locale}`, `/${otherLocale}`) || `/${otherLocale}`;
const menuLabel = locale === 'ua' ? 'Меню' : 'Меню';
const closeLabel = locale === 'ua' ? 'Закрити' : 'Закрыть';

function hrefForLink(link: { _type: string; slug: string | null } | null, locale: string): string {
  if (!link) return '#';
  if (link._type === 'homePage') return `/${locale}/`;
  if ((link._type === 'page' || link._type === 'faq' || link._type === 'selfTest') && link.slug) {
    return `/${locale}/${link.slug}`;
  }
  return '#';
}
---

<header class="border-b border-gray-200" data-header>
  <div class="max-w-5xl mx-auto px-8 py-4 flex items-center justify-between gap-6">
    <a href={`/${locale}/`} class="shrink-0 block [contain:layout_paint]" aria-label="Home">
      {siteSettings?.logo ? (
        <img
          src={urlForImage(siteSettings.logo).width(140).height(140).url()}
          srcset={`${urlForImage(siteSettings.logo).width(80).height(80).url()} 80w, ${urlForImage(siteSettings.logo).width(140).height(140).url()} 140w, ${urlForImage(siteSettings.logo).width(280).height(280).url()} 280w`}
          sizes="80px (max-width: 767px), 140px"
          alt=""
          width="140"
          height="140"
          class="logo-img h-[80px] w-[80px] md:h-[140px] md:w-[140px] object-contain"
          loading="eager"
          decoding="async"
        />
      ) : (
        <span class="font-heading text-h3">Logo</span>
      )}
    </a>

    {menu && menu.length > 0 && (
      <nav class="hidden md:flex items-center gap-6" aria-label="Main">
        {menu.map((item) => (
          <a
            href={hrefForLink(item.link, locale)}
            class="text-body text-gray-700 hover:text-gray-900 underline-offset-2 hover:underline"
          >
            {item.label ?? ''}
          </a>
        ))}
      </nav>
    )}

    <div class="hidden md:flex items-center gap-4 shrink-0">
      <a
        href={locale === 'ua' ? currentPath : otherPath}
        class={`text-body ${locale === 'ua' ? 'font-semibold underline' : 'text-gray-600 hover:text-gray-900'}`}
        hreflang="uk"
      >
        Українська
      </a>
      <a
        href={locale === 'ru' ? currentPath : otherPath}
        class={`text-body ${locale === 'ru' ? 'font-semibold underline' : 'text-gray-600 hover:text-gray-900'}`}
        hreflang="ru"
      >
        Русский
      </a>
    </div>

    <button
      type="button"
      class="md:hidden inline-flex items-center justify-center gap-2 border border-gray-300 rounded px-3 py-2 text-sm text-gray-800"
      aria-controls="mobile-menu"
      aria-expanded="false"
      data-menu-toggle
    >
      <span class="sr-only">{menuLabel}</span>
      <span aria-hidden="true" class="flex flex-col gap-1">
        <span class="block w-5 h-0.5 bg-gray-800"></span>
        <span class="block w-5 h-0.5 bg-gray-800"></span>
        <span class="block w-5 h-0.5 bg-gray-800"></span>
      </span>
    </button>
  </div>

  <div id="mobile-menu" class="md:hidden hidden border-t border-gray-200 bg-white">
    <div class="max-w-5xl mx-auto px-6 py-6 space-y-6">
      {menu && menu.length > 0 && (
        <nav class="flex flex-col gap-4" aria-label="Main mobile">
          {menu.map((item) => (
            <a
              href={hrefForLink(item.link, locale)}
              class="text-base text-gray-700 hover:text-gray-900 underline-offset-2 hover:underline"
            >
              {item.label ?? ''}
            </a>
          ))}
        </nav>
      )}

      <div class="flex items-center gap-4">
        <a
          href={locale === 'ua' ? currentPath : otherPath}
          class={`text-base ${locale === 'ua' ? 'font-semibold underline' : 'text-gray-600 hover:text-gray-900'}`}
          hreflang="uk"
        >
          Українська
        </a>
        <a
          href={locale === 'ru' ? currentPath : otherPath}
          class={`text-base ${locale === 'ru' ? 'font-semibold underline' : 'text-gray-600 hover:text-gray-900'}`}
          hreflang="ru"
        >
          Русский
        </a>
      </div>

      <button
        type="button"
        class="text-sm text-gray-500 hover:text-gray-700 underline-offset-2 hover:underline"
        data-menu-close
      >
        {closeLabel}
      </button>
    </div>
  </div>
</header>

<script type="module" is:inline>
  const header = document.querySelector('[data-header]');
  if (header) {
    const toggle = header.querySelector('[data-menu-toggle]');
    const closeBtn = header.querySelector('[data-menu-close]');
    const menu = header.querySelector('#mobile-menu');

    const setOpen = (open) => {
      if (!menu || !toggle) return;
      menu.classList.toggle('hidden', !open);
      toggle.setAttribute('aria-expanded', String(open));
    };

    if (toggle) {
      toggle.addEventListener('click', () => {
        const isOpen = toggle.getAttribute('aria-expanded') === 'true';
        setOpen(!isOpen);
      });
    }

    if (closeBtn) {
      closeBtn.addEventListener('click', () => setOpen(false));
    }
  }
</script>
