---
import PortableText from './PortableText.astro';
import type { HomePageQueryResult, SiteSettingsQueryResult } from '../sanity-types';

interface Props {
  data: HomePageQueryResult;
  contact: SiteSettingsQueryResult extends { contact: infer C } ? C : unknown;
  locale: 'ua' | 'ru';
}

const { data, contact, locale } = Astro.props;

const t = {
  ua: { when: 'Коли', where: 'Де', languages: 'Мови', phone: 'Телефон', callUs: 'Зателефонуйте нам' },
  ru: { when: 'Когда', where: 'Где', languages: 'Языки', phone: 'Телефон', callUs: 'Позвоните нам' },
}[locale];

const mapLocation = contact?.mapLocation ?? null;
const hasMap = mapLocation && mapLocation.lat != null && mapLocation.lng != null;
const mapBbox = hasMap
  ? [
      (mapLocation!.lng! - 0.008).toFixed(5),
      (mapLocation!.lat! - 0.005).toFixed(5),
      (mapLocation!.lng! + 0.008).toFixed(5),
      (mapLocation!.lat! + 0.005).toFixed(5),
    ].join(',')
  : '';
const mapMarker = hasMap ? `${mapLocation!.lat!.toFixed(5)},${mapLocation!.lng!.toFixed(5)}` : '';
const mapEmbedUrl =
  hasMap &&
  `https://www.openstreetmap.org/export/embed.html?bbox=${mapBbox}&layer=mapnik&marker=${mapMarker}`;
---

<div class="max-w-5xl mx-auto px-6 sm:px-8 py-16">
  <div class="intro space-y-10">
    {data.introText && <PortableText value={data.introText} />}
  </div>

  {data.meetingSection && (
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-12 items-start">
      <div class="space-y-4">
        <h2 class="text-lg font-semibold">{data.meetingSection.sectionTitle}</h2>

        <div class="flex gap-2">
          <span class="font-semibold shrink-0">{t.when}:</span>
          <span>{data.meetingSection.time}</span>
        </div>

        <div class="flex gap-2">
          <span class="font-semibold shrink-0">{t.where}:</span>
          <span>{contact?.address ?? ''}</span>
        </div>

        <div class="flex gap-2">
          <span class="font-semibold shrink-0">{t.languages}:</span>
          <span>{data.meetingSection.languages}</span>
        </div>

        <div class="flex gap-2">
          <span class="font-semibold shrink-0">{t.phone}:</span>
          <a href={contact?.phone ? `tel:${contact.phone}` : '#'} class="text-[#0B4A78] hover:underline">
            {contact?.phone ?? ''}
          </a>
        </div>

        {contact?.phone && (
          <div class="pt-2">
            <a
              href={`tel:${contact.phone}`}
              class="inline-block px-4 py-2 text-white rounded hover:opacity-90 transition-opacity"
              style="background-color: #1371AF;"
            >
              {t.callUs}
            </a>
          </div>
        )}
      </div>

      <div class="min-h-[300px] rounded overflow-hidden bg-gray-100">
        {mapEmbedUrl ? (
          <div
            class="w-full h-[300px] flex flex-col items-center justify-center gap-3 text-center px-6"
            data-map-container
            data-map-src={mapEmbedUrl}
          >
            <span class="text-gray-600 text-sm">Карта загрузится по запросу</span>
            <button
              type="button"
              class="inline-flex items-center justify-center px-4 py-2 text-white rounded hover:opacity-90 transition-opacity"
              style="background-color: #1371AF;"
              data-map-load
            >
              Показать карту
            </button>
            <noscript>
              <iframe
                title="Map"
                src={mapEmbedUrl}
                class="w-full h-[300px] border-0"
                loading="lazy"
                referrerpolicy="no-referrer-when-downgrade"
              />
            </noscript>
          </div>
        ) : (
          <div class="w-full h-[300px] flex items-center justify-center">
            <span class="text-gray-500 text-sm">
              {hasMap ? null : mapLocation ? 'Map: invalid coordinates' : 'Map: add coordinates in Studio'}
            </span>
          </div>
        )}
      </div>
    </div>
  )}
</div>

<script type="module" is:inline>
  const container = document.querySelector('[data-map-container]');
  if (container) {
    const button = container.querySelector('[data-map-load]');
    const src = container.getAttribute('data-map-src');
    const load = () => {
      if (!src) return;
      const iframe = document.createElement('iframe');
      iframe.title = 'Map';
      iframe.src = src;
      iframe.className = 'w-full h-[300px] border-0';
      iframe.loading = 'lazy';
      iframe.referrerPolicy = 'no-referrer-when-downgrade';
      container.replaceWith(iframe);
    };
    if (button) button.addEventListener('click', load);
  }
</script>
