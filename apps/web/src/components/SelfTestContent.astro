---
import PortableText from './PortableText.astro';
import type { BlockContent } from '../sanity-types';

interface SelfTestQuestion {
  text?: string;
}

interface Props {
  intro?: BlockContent | null;
  questions?: SelfTestQuestion[] | null;
  resultCopy?: BlockContent | null;
  contact?: { phone?: string | null } | null;
  locale: 'ua' | 'ru';
}

const { intro, questions, resultCopy, contact, locale } = Astro.props;
const label = locale === 'ua' ? 'Кількість відповідей “Так”' : 'Количество ответов «Да»';
const yesLabel = locale === 'ua' ? 'Так' : 'Да';
const noLabel = locale === 'ua' ? 'Ні' : 'Нет';
const callUsLabel = locale === 'ua' ? 'Зателефонуйте нам' : 'Позвоните нам';
---

<div class="max-w-3xl mx-auto px-8 py-16 space-y-8" data-self-test>
  {intro && <PortableText value={intro} />}

  <div class="text-body text-gray-700">
    <span>{label}:</span>{' '}
    <strong class="text-body text-gray-900 font-semibold" data-self-test-count>0</strong>
    {questions && questions.length > 0 ? ` / ${questions.length}` : ''}
  </div>

  {questions && questions.length > 0 && (
    <div class="space-y-6">
      {questions.map((q, idx) => (
        <div class="space-y-2">
          <div class="font-medium">{q.text}</div>
          <div class="flex gap-6 text-sm">
            <label class="inline-flex items-center gap-2">
              <input
                type="radio"
                name={`self-test-${idx}`}
                value="yes"
                class="h-4 w-4 accent-[#1371AF]"
                data-self-test-input
              />
              <span>{yesLabel}</span>
            </label>
            <label class="inline-flex items-center gap-2">
              <input
                type="radio"
                name={`self-test-${idx}`}
                value="no"
                class="h-4 w-4 accent-[#1371AF]"
                data-self-test-input
              />
              <span>{noLabel}</span>
            </label>
          </div>
        </div>
      ))}
    </div>
  )}

  {resultCopy && (
    <div class="pt-4 border-t border-gray-200">
      <PortableText value={resultCopy} />
    </div>
  )}

  {contact?.phone && (
    <div class="pt-2 flex justify-center">
      <a
        href={`tel:${contact.phone}`}
        class="inline-block px-4 py-2 text-white rounded hover:opacity-90 transition-opacity"
        style="background-color: #1371AF;"
      >
        {callUsLabel}
      </a>
    </div>
  )}
</div>

<script type="module" is:inline>
  const container = document.querySelector('[data-self-test]');
  if (container) {
    const countEl = container.querySelector('[data-self-test-count]');
    const inputs = container.querySelectorAll('[data-self-test-input]');
    const update = () => {
      let total = 0;
      inputs.forEach((input) => {
        if (input instanceof HTMLInputElement && input.checked && input.value === 'yes') total += 1;
      });
      if (countEl) countEl.textContent = String(total);
    };
    inputs.forEach((input) => input.addEventListener('change', update));
  }
</script>
